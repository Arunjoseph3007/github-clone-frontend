<VirtualHost *:8000>
    ServerName gitbase.com
    ServerAlias www.gitbase.com
    ServerAdmin webmaster@localhost

    SetEnv GIT_PROJECT_ROOT /var/www/git
    SetEnv GIT_HTTP_EXPORT_ALL
    PassEnv NEXT_PUBLIC_API
    ScriptAliasMatch "(?x)^/(.*/(HEAD|info/refs|objects/(info/[^/]+|[0-9a-f]{2}/[0-9a-f]{38}|pack/pack-[0-9a-f]{40}\.(pack|idx))|git-(upload|receive)-pack))" "/usr/lib/git-core/git-http-backend/$1"
    DefineExternalAuth authTest environment /usr/local/bin/authScript.js

    ProxyRequests Off
    ProxyPreserveHost On
    ProxyVia Full

    RewriteEngine on
    RewriteCond %{DOCUMENT_ROOT}/$1 -f
    RewriteRule (.*) - [L]

    # Else proxy
    RewriteCond %{REQUEST_URI} !^/(.*/(HEAD|info/refs|objects/(info/[^/]+|[0-9a-f]{2}/[0-9a-f]{38}|pack/pack-[0-9a-f]{40}\.(pack|idx))|git-(upload|receive)-pack))
    RewriteRule ^/(.*)$ http://localhost:3000/$1 [P,QSA]
    ProxyPassReverse / http://localhost:3000/

    <Directory /usr/lib/git-core>
        Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
        AllowOverride None
        Require all granted
    </Directory>

    DocumentRoot /var/www/html

    <Directory /var/www>
        Options Indexes FollowSymLinks MultiViews
        AllowOverride None
        Require all granted
    </Directory>

    <LocationMatch (?x)^/(.*/(HEAD|info/refs|objects/(info/[^/]+|[0-9a-f]{2}/[0-9a-f]{38}|pack/pack-[0-9a-f]{40}\.(pack|idx))|git-upload-pack))$>
        AuthType Basic
        AuthName "Python auth"
        AuthBasicProvider external
        AuthExternal authTest
        AuthExternalContext "GET"
        Require valid-user
    </LocationMatch>

    <LocationMatch (?x)^/(.*/(git-receive-pack))$>
        AuthType Basic
        AuthName "Python auth"
        AuthBasicProvider external
        AuthExternal authTest
        AuthExternalContext "POST"
        Require valid-user
    </LocationMatch>

    ErrorLog ${APACHE_LOG_DIR}/error.log
    LogLevel warn
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>